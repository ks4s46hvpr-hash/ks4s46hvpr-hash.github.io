<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ºå¡ç”Ÿæˆå·¥å…·</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #fff5f5; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 300px; text-align: center; }
        h2 { color: #d63031; margin-bottom: 20px; }
        input { padding: 12px; width: 85%; margin: 8px 0; border: 2px solid #ffcfcf; border-radius: 8px; outline: none; }
        button { padding: 12px; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer; width: 95%; margin-top: 10px; font-weight: bold; }
        #canvas-container { margin-top: 20px; display: none; }
        canvas { max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .tip { font-size: 14px; color: #ff7675; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="box">
        <h2>ğŸ§§ è´ºå¡ç”Ÿæˆå·¥å…·</h2>
        <input type="text" id="custName" placeholder="å®¢æˆ·å§“å">
        <input type="text" id="custDate" placeholder="æ˜¾ç¤ºæ—¥æœŸ">
        <button onclick="generate()">ç”Ÿæˆå¼•å¯¼æµ·æŠ¥</button>
        <p id="statusTip" class="tip" style="display:none;">å·²è‡ªåŠ¨å¤åˆ¶é“¾æ¥ï¼Œè¯·é•¿æŒ‰ä¸‹æ–¹å›¾ç‰‡ä¿å­˜</p>
    </div>

    <div id="canvas-container">
        <canvas id="myCanvas"></canvas>
    </div>

    <script>
        // 1. åˆå§‹åŒ–æ—¥æœŸ
        const today = new Date();
        document.getElementById('custDate').value = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ`;

        function generate() {
            const name = document.getElementById('custName').value;
            const date = document.getElementById('custDate').value;
            if(!name) return alert('è¯·è¾“å…¥å§“å');

            // 2. æ„é€  H5 é“¾æ¥
            const currentDir = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const finalUrl = `${currentDir}card.html?n=${encodeURIComponent(name)}&d=${encodeURIComponent(date)}`;

            // 3. è‡ªåŠ¨å¤åˆ¶é“¾æ¥ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
            const el = document.createElement('textarea');
            el.value = finalUrl;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            // 4. è·å–äºŒç»´ç å›¾ç‰‡å¹¶åˆæˆ
            const canvas = document.getElementById('myCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 600;
            canvas.height = 900;

            // ç»˜åˆ¶åº•è‰²å’Œè¾¹æ¡†
            ctx.fillStyle = "#d63031";
            ctx.fillRect(0, 0, 600, 900);
            ctx.strokeStyle = "#f1c40f";
            ctx.lineWidth = 20;
            ctx.strokeRect(30, 30, 540, 840);

            // ç»˜åˆ¶æ–‡å­—
            ctx.fillStyle = "#f1c40f";
            ctx.textAlign = "center";
            ctx.font = "bold 50px sans-serif";
            ctx.fillText("ä¸“å±åŠ¨æ€è´ºå¡", 300, 150);
            ctx.fillStyle = "#ffffff";
            ctx.font = "34px sans-serif";
            ctx.fillText(`è‡´ï¼š${name}`, 300, 280);

            // å…³é”®ï¼šé€šè¿‡å…¬å¼€æ¥å£è¯·æ±‚äºŒç»´ç å›¾ç‰‡
            const qrImg = new Image();
            qrImg.crossOrigin = "anonymous"; // å¤„ç†è·¨åŸŸ
            qrImg.src = `https://api.qrserver.com{encodeURIComponent(finalUrl)}`;

            qrImg.onload = function() {
                // ç”»äºŒç»´ç ç™½åº•
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(150, 350, 300, 300);
                // æŠŠäºŒç»´ç ç”»ä¸Šå»
                ctx.drawImage(qrImg, 150, 350, 300, 300);
                
                ctx.fillStyle = "#f1c40f";
                ctx.font = "24px sans-serif";
                ctx.fillText("é•¿æŒ‰è¯†åˆ« Â· æ‹†å¼€è´ºå¡", 300, 800);

                document.getElementById('canvas-container').style.display = 'block';
                document.getElementById('statusTip').style.display = 'block';
                window.scrollTo(0, document.body.scrollHeight);
            };
            
            qrImg.onerror = function() {
                alert("äºŒç»´ç åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¤šç‚¹å‡ æ¬¡ç”Ÿæˆã€‚");
            };
        }
    </script>
</body>
</html>
