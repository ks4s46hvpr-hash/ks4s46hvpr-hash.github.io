<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ºå¡ç”Ÿæˆå™¨ - ç¨³å®šç‰ˆ</title>
    <!-- ä½¿ç”¨æ›´ç¨³å®šçš„ CDN æˆ–ç›´æ¥å†…ç½® -->
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #fff5f5; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 320px; text-align: center; border: 1px solid #ffcfcf; }
        h2 { color: #d63031; }
        input { padding: 12px; width: 85%; margin: 10px 0; border: 2px solid #ffcfcf; border-radius: 8px; outline: none; }
        button { padding: 12px; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer; width: 95%; margin-top: 10px; font-weight: bold; font-size: 16px; }
        #canvas-container { margin-top: 20px; display: none; }
        canvas { max-width: 100%; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 2px solid #fff; }
        .tip { font-size: 13px; color: #ff7675; margin-top: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="box">
        <h2>ğŸ§§ è´ºå¡ç”Ÿæˆå·¥å…·</h2>
        <input type="text" id="custName" placeholder="å®¢æˆ·å°Šç§° (å¦‚: ç‹æ€»)">
        <input type="text" id="custDate" placeholder="æ—¥æœŸ (å¦‚: 2025å¹´2æœˆ)">
        <button onclick="generatePoster()">ç”ŸæˆäºŒç»´ç å¼•å¯¼å›¾</button>
        <p id="statusTip" class="tip" style="display:none;">â†“ é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜å‘é€ç»™å®¢æˆ·</p>
    </div>

    <div id="canvas-container">
        <canvas id="myCanvas"></canvas>
    </div>

    <!-- éšè—çš„äºŒç»´ç å¤„ç†ä½ -->
    <canvas id="qr-hidden" style="display:none;"></canvas>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸ
        const today = new Date();
        document.getElementById('custDate').value = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ`;

        function generatePoster() {
            const name = document.getElementById('custName').value;
            const date = document.getElementById('custDate').value;
            if(!name) return alert('è¯·è¾“å…¥å®¢æˆ·å§“å');

            // 1. ç”Ÿæˆæœ€ç»ˆ H5 é“¾æ¥
            const currentDir = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const finalUrl = `${currentDir}card.html?n=${encodeURIComponent(name)}&d=${encodeURIComponent(date)}`;

            try {
                // 2. ä½¿ç”¨ QRious ç”ŸæˆäºŒç»´ç åˆ°éšè— Canvas
                const qr = new QRious({
                    element: document.getElementById('qr-hidden'),
                    value: finalUrl,
                    size: 300,
                    level: 'H'
                });

                // 3. åˆæˆæµ·æŠ¥
                const mainCanvas = document.getElementById('myCanvas');
                const ctx = mainCanvas.getContext('2d');
                const qrCanvas = document.getElementById('qr-hidden');

                mainCanvas.width = 600;
                mainCanvas.height = 900;

                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = "#d63031"; // è¿™é‡Œåç»­å¯ä»¥æ¢æˆ ctx.drawImage ç»˜åˆ¶ä½ è®¾è®¡çš„ cover.jpg
                ctx.fillRect(0, 0, 600, 900);

                // ç»˜åˆ¶è£…é¥°æ¡†
                ctx.strokeStyle = "#f1c40f";
                ctx.lineWidth = 10;
                ctx.strokeRect(20, 20, 560, 860);

                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = "#f1c40f";
                ctx.textAlign = "center";
                ctx.font = "bold 45px Microsoft YaHei";
                ctx.fillText("ä¸“å±æ–°æ˜¥è´ºå¡", 300, 150);
                
                ctx.fillStyle = "#ffffff";
                ctx.font = "32px Microsoft YaHei";
                ctx.fillText(`è‡´ï¼š${name}`, 300, 280);

                // ç»˜åˆ¶äºŒç»´ç ç™½åº•
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(140, 340, 320, 320);

                // æŠŠäºŒç»´ç ç”»ä¸Šå»
                ctx.drawImage(qrCanvas, 150, 350, 300, 300);

                // ç»˜åˆ¶åº•éƒ¨è¯´æ˜
                ctx.fillStyle = "#f1c40f";
                ctx.font = "24px Microsoft YaHei";
                ctx.fillText("é•¿æŒ‰è¯†åˆ«äºŒç»´ç  Â· æŸ¥çœ‹åŠ¨æ€è´ºå¡", 300, 800);

                document.getElementById('canvas-container').style.display = 'block';
                document.getElementById('statusTip').style.display = 'block';
                
                // è‡ªåŠ¨è·³è½¬åˆ°å›¾ç‰‡ä½ç½®æ–¹ä¾¿æ“ä½œ
                mainCanvas.scrollIntoView({behavior: "smooth"});

            } catch (e) {
                console.error(e);
                alert("äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            }
        }
    </script>
</body>
</html>
