<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ºå¡ç”Ÿæˆå™¨ - å¸¦å¼•å¯¼å›¾ç‰ˆ</title>
    <!-- å¼•å…¥äºŒç»´ç ç”Ÿæˆåº“ -->
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 340px; text-align: center; }
        input { padding: 10px; width: 80%; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; width: 85%; margin-top: 10px; font-weight: bold; }
        #canvas-container { margin-top: 20px; display: none; }
        canvas { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .tip { font-size: 12px; color: #666; margin-top: 10px; }
        /* éšè—åŸå§‹äºŒç»´ç å®¹å™¨ */
        #qrcode-hidden { display: none; }
    </style>
</head>
<body>
    <div class="box">
        <h2>ğŸ§§ è´ºå¡åˆ†å‘ç³»ç»Ÿ</h2>
        <input type="text" id="custName" placeholder="å®¢æˆ·å°Šç§°">
        <input type="text" id="custDate" placeholder="æ—¥æœŸ (å¦‚: 2025å¹´2æœˆ)">
        <button onclick="generatePoster()">1. ç”ŸæˆäºŒç»´ç å¼•å¯¼å›¾</button>
        <p class="tip">ç”Ÿæˆåï¼Œé•¿æŒ‰/å³é”®ä¿å­˜ä¸‹æ–¹å›¾ç‰‡å‘ç»™å®¢æˆ·</p>
    </div>

    <!-- éšè—çš„äºŒç»´ç ç”Ÿæˆä½ -->
    <div id="qrcode-hidden"></div>

    <!-- å±•ç¤ºç»™å®¢æœçœ‹çš„åˆæˆå›¾ -->
    <div id="canvas-container">
        <canvas id="myCanvas"></canvas>
    </div>

    <script>
        // åˆå§‹æ—¥æœŸ
        const today = new Date();
        document.getElementById('custDate').value = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ`;

        function generatePoster() {
            const name = document.getElementById('custName').value;
            const date = document.getElementById('custDate').value;
            if(!name) return alert('è¯·è¾“å…¥åå­—');

            // 1. ç”Ÿæˆæœ€ç»ˆçš„ H5 é“¾æ¥
            const currentDir = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const finalUrl = `${currentDir}card.html?n=${encodeURIComponent(name)}&d=${encodeURIComponent(date)}`;

            // 2. åœ¨å†…å­˜ä¸­ç”ŸæˆäºŒç»´ç 
            const qrcodeDiv = document.getElementById("qrcode-hidden");
            qrcodeDiv.innerHTML = ""; // æ¸…ç©º
            new QRCode(qrcodeDiv, {
                text: finalUrl,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // 3. ä½¿ç”¨ Canvas åˆæˆå›¾ç‰‡
            setTimeout(() => {
                const canvas = document.getElementById('myCanvas');
                const ctx = canvas.getContext('2d');
                const qrImg = qrcodeDiv.getElementsByTagName('img')[0];

                // è®¾ç½®ç”»å¸ƒå°ºå¯¸ (ä¾‹å¦‚ 600x900)
                canvas.width = 600;
                canvas.height = 900;

                // ç»˜åˆ¶çº¢è‰²èƒŒæ™¯/å°é¢
                ctx.fillStyle = "#d63031";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // ç»˜åˆ¶è£…é¥°æ€§æ–‡å­—
                ctx.fillStyle = "#f1c40f";
                ctx.font = "bold 40px Microsoft YaHei";
                ctx.textAlign = "center";
                ctx.fillText("ä¸“å±æ–°æ˜¥è´ºå¡", canvas.width/2, 150);
                
                ctx.fillStyle = "#ffffff";
                ctx.font = "30px Microsoft YaHei";
                ctx.fillText(`è‡´ï¼š${name}`, canvas.width/2, 250);

                // ç»˜åˆ¶æç¤ºè¯­
                ctx.font = "20px Microsoft YaHei";
                ctx.fillText("é•¿æŒ‰è¯†åˆ«äºŒç»´ç æŸ¥çœ‹å®Œæ•´åŠ¨æ€è´ºå¡", canvas.width/2, 820);

                // æŠŠäºŒç»´ç ç”»ä¸Šå» (å±…ä¸­)
                ctx.drawImage(qrImg, 150, 350, 300, 300);

                document.getElementById('canvas-container').style.display = 'block';
                alert('å¼•å¯¼å›¾å·²ç”Ÿæˆï¼Œè¯·é•¿æŒ‰ä¿å­˜å›¾ç‰‡');
            }, 300);
        }
    </script>
</body>
</html>
